# 数据格式说明

> 本文档定义 Financial Data Fetch Skill 返回的数据格式标准

## 股票数据格式

### DataFrame Schema

| 列名 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 日期 | datetime64 | 交易日期 | 2024-12-15 |
| 开盘 | float64 | 开盘价（元） | 10.50 |
| 收盘 | float64 | 收盘价（元） | 10.80 |
| 最高 | float64 | 最高价（元） | 11.00 |
| 最低 | float64 | 最低价（元） | 10.45 |
| 成交量 | int64 | 成交量（手） | 123456 |
| 成交额 | float64 | 成交额（元） | 1234567.89 |
| 涨跌幅 | float64 | 涨跌幅（%） | 2.86 |

### 示例数据

```python
import pandas as pd

# 股票数据示例
stock_data = pd.DataFrame({
    '日期': ['2024-12-13', '2024-12-14', '2024-12-15'],
    '开盘': [10.50, 10.80, 10.75],
    '收盘': [10.80, 10.75, 11.00],
    '最高': [11.00, 10.90, 11.20],
    '最低': [10.45, 10.70, 10.70],
    '成交量': [123456, 98765, 145678],
    '成交额': [1234567.89, 987654.32, 1456789.01],
    '涨跌幅': [2.86, -0.46, 2.33]
})
```

## ETF 数据格式

### DataFrame Schema

| 列名 | 类型 | 说明 | 示例 |
|------|------|------|------|
| 日期 | datetime64 | 交易日期 | 2024-12-15 |
| 开盘 | float64 | 开盘价（元） | 3.50 |
| 收盘 | float64 | 收盘价（元） | 3.55 |
| 最高 | float64 | 最高价（元） | 3.58 |
| 最低 | float64 | 最低价（元） | 3.48 |
| 成交量 | int64 | 成交量（手） | 234567 |

### 示例数据

```python
# ETF 数据示例
etf_data = pd.DataFrame({
    '日期': ['2024-12-13', '2024-12-14', '2024-12-15'],
    '开盘': [3.50, 3.55, 3.53],
    '收盘': [3.55, 3.53, 3.60],
    '最高': [3.58, 3.56, 3.62],
    '最低': [3.48, 3.50, 3.52],
    '成交量': [234567, 198765, 256789]
})
```

## 数据约束

### 1. 必需字段

**股票数据**:
- ✅ 日期、开盘、收盘、最高、最低、成交量（6个核心字段）
- ⚠️  成交额、涨跌幅为可选字段

**ETF数据**:
- ✅ 日期、开盘、收盘、最高、最低、成交量（6个核心字段）

### 2. 数据类型转换

```python
# 标准化处理
df['日期'] = pd.to_datetime(df['日期'])
df['开盘'] = df['开盘'].astype(float)
df['收盘'] = df['收盘'].astype(float)
df['成交量'] = df['成交量'].astype(int)
```

### 3. 缺失值处理

- **价格字段**: 不允许 NaN（如有缺失，使用前一日收盘价填充）
- **成交量**: 不允许 NaN（如有缺失，填充为 0）
- **成交额**: 允许 NaN（不影响后续计算）

### 4. 排序规则

- ✅ 按日期升序排列（最旧日期在前）
- ✅ 索引重置为 0, 1, 2, ...

## 数据质量检查

### 1. 价格逻辑检查

```python
# 确保价格关系正确
assert (df['最高'] >= df['最低']).all(), "最高价必须 >= 最低价"
assert (df['最高'] >= df['开盘']).all(), "最高价必须 >= 开盘价"
assert (df['最高'] >= df['收盘']).all(), "最高价必须 >= 收盘价"
assert (df['最低'] <= df['开盘']).all(), "最低价必须 <= 开盘价"
assert (df['最低'] <= df['收盘']).all(), "最低价必须 <= 收盘价"
```

### 2. 数据完整性检查

```python
# 检查必需字段
required_columns = ['日期', '开盘', '收盘', '最高', '最低', '成交量']
assert all(col in df.columns for col in required_columns), "缺少必需字段"
```

### 3. 时间连续性检查

```python
# 检查是否有重复日期
assert not df['日期'].duplicated().any(), "存在重复日期"
```

## 返回格式约定

### 1. 成功响应

```python
{
    "success": True,
    "data": pd.DataFrame(...),
    "rows": 30,
    "start_date": "2024-11-15",
    "end_date": "2024-12-15"
}
```

### 2. 错误响应

```python
{
    "success": False,
    "error": "股票代码 '999999' 不存在",
    "data": None
}
```

## 使用示例

```python
# 获取股票数据
result = fetch_stock_data(symbol="000001", days=30)

# 验证数据格式
assert result['success'] == True
df = result['data']

# 检查列名
assert '日期' in df.columns
assert '收盘' in df.columns

# 检查数据类型
assert df['日期'].dtype == 'datetime64[ns]'
assert df['收盘'].dtype == 'float64'
```
