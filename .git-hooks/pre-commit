#!/bin/bash
# Git pre-commit hook - 提交前自动质量检查
# 安装方法: chmod +x pre-commit && cp pre-commit .git/hooks/

set -e

echo "🔍 运行提交前检查..."

# 获取项目根目录（已经在正确目录下）
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 检查函数
check_step() {
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}✅ $1 通过${NC}"
        return 0
    else
        echo -e "${RED}❌ $1 失败${NC}"
        return 1
    fi
}

# 1. 代码格式检查（可选，如果安装了 black）
if command -v black &> /dev/null; then
    echo -e "\n${YELLOW}📝 检查代码格式...${NC}"
    black --check core/ agent_logic.py 2>/dev/null || {
        echo -e "${YELLOW}⚠️  代码格式不符合规范，正在自动格式化...${NC}"
        black core/ agent_logic.py
        git add core/ agent_logic.py
        echo -e "${GREEN}✅ 代码已自动格式化并添加到暂存区${NC}"
    }
else
    echo -e "${YELLOW}ℹ️  跳过代码格式检查（未安装 black）${NC}"
fi

# 2. 类型检查（可选，如果安装了 mypy）
if command -v mypy &> /dev/null; then
    echo -e "\n${YELLOW}🔍 运行类型检查...${NC}"
    mypy core/ --ignore-missing-imports --no-strict-optional 2>/dev/null || {
        echo -e "${YELLOW}⚠️  类型检查发现问题，但不阻止提交${NC}"
    }
else
    echo -e "${YELLOW}ℹ️  跳过类型检查（未安装 mypy）${NC}"
fi

# 3. 语法检查
echo -e "\n${YELLOW}🐍 检查 Python 语法...${NC}"
python -m py_compile core/*.py agent_logic.py
check_step "语法检查" || exit 1

# 4. 导入检查
echo -e "\n${YELLOW}📦 检查模块导入...${NC}"
python -c "
import sys
sys.path.insert(0, '.')
try:
    from core import *
    from agent_logic import *
    print('✅ 所有模块导入成功')
except Exception as e:
    print(f'❌ 导入失败: {e}')
    sys.exit(1)
"
check_step "模块导入" || exit 1

# 5. 快速单元测试（如果存在 tests 目录）
if [ -d "tests" ]; then
    echo -e "\n${YELLOW}🧪 运行单元测试...${NC}"
    python -m pytest tests/ -v --tb=short
    check_step "单元测试" || exit 1
else
    echo -e "${YELLOW}ℹ️  跳过单元测试（tests 目录不存在）${NC}"
fi

# 6. 性能回归检测（可选）
if [ -f "optimization/benchmarks/latest_baseline.json" ]; then
    echo -e "\n${YELLOW}📊 检查性能回归...${NC}"
    
    # 简单的性能回归检测脚本
    python -c "
import json
import sys
from pathlib import Path

benchmark_dir = Path('optimization/benchmarks')
latest_file = benchmark_dir / 'latest_baseline.json'

if latest_file.exists():
    with open(latest_file) as f:
        baseline = json.load(f)
    
    # 这里可以添加更复杂的回归检测逻辑
    # 目前只是验证文件存在
    print('✅ 性能基准文件有效')
else:
    print('ℹ️  未找到性能基准文件')
" || {
        echo -e "${YELLOW}⚠️  性能回归检测失败，但不阻止提交${NC}"
    }
else
    echo -e "${YELLOW}ℹ️  跳过性能回归检测（未建立基准）${NC}"
fi

# 7. 文档更新提醒
echo -e "\n${YELLOW}📄 检查文档更新...${NC}"
CHANGED_FILES=$(git diff --cached --name-only)

if echo "$CHANGED_FILES" | grep -qE "core/|agent_logic.py"; then
    if ! echo "$CHANGED_FILES" | grep -qE "README.md|docs.md|spec.md"; then
        echo -e "${YELLOW}⚠️  警告: 修改了核心代码但未更新文档${NC}"
        echo -e "${YELLOW}   建议同步更新: README.md, docs.md, spec.md${NC}"
        # 仅警告，不阻止提交
    fi
fi

# 8. Commit Message 检查
COMMIT_MSG_FILE="$1"
if [ -n "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
    
    # 检查是否包含 emoji 和类型标识
    if ! echo "$COMMIT_MSG" | grep -qE "^(⚡|🐛|📝|✨|🔧|🎨|♻️|🔥|✅|🚀)"; then
        echo -e "${YELLOW}⚠️  建议使用 emoji 前缀的提交信息:${NC}"
        echo "  ⚡ 性能优化"
        echo "  🐛 Bug 修复"
        echo "  📝 文档更新"
        echo "  ✨ 新功能"
        echo "  🔧 配置修改"
        echo "  🎨 代码格式"
        echo "  ♻️  代码重构"
        echo "  🔥 删除代码"
        echo "  ✅ 测试相关"
        echo "  🚀 部署相关"
    fi
fi

echo -e "\n${GREEN}✅ 所有检查通过，可以提交！${NC}"
exit 0
